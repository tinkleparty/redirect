<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>
<style>
  body { background-color: #111; color: white; font-family: Arial, sans-serif; margin: 0; padding: 20px; }
  h1 { color: #4CAF50; }
  input, textarea { width: 100%; padding: 8px; margin: 10px 0; border-radius: 6px; border: none; outline: none; font-size: 14px; }
  button { background-color: #4CAF50; color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 14px; }
  button:hover { background-color: #45a049; }
  .revert { background-color: #d9534f; margin-left: 10px; }
  .revert:hover { background-color: #c9302c; }
  #login-box { text-align: center; margin-top: 100px; }
  #admin-content { display: none; max-width: 600px; margin: auto; }
  label { display: block; margin-top: 20px; font-weight: bold; }
  .group { display: flex; align-items: center; gap: 10px; }
  input[type="color"] { width: 60px; height: 35px; padding: 0; border-radius: 4px; }
</style>
</head>
<body>

<div id="login-box">
  <h2>ğŸ”’ Admin Login</h2>
  <input type="email" id="admin-email" placeholder="Email">
  <input type="password" id="admin-pass" placeholder="Password">
  <button id="login-btn">Login</button>
</div>

<div id="admin-content">
  <h1>ğŸ› ï¸ Live Site Controls</h1>

  <label>ğŸ¨ Background Color:</label>
  <div class="group">
    <input type="color" id="bgColor">
    <button class="revert" id="revert-bg">Revert</button>
  </div>

  <label>ğŸ§¾ Announcement (HTML supported):</label>
  <div class="group" style="flex-direction: column; align-items: flex-start;">
    <textarea id="announcement" rows="3" placeholder="Enter announcement..."></textarea>
    <div>
      <button id="trigger-announcement">ğŸ“¢ Trigger Announcement</button>
      <button class="revert" id="revert-ann">Revert</button>
    </div>
  </div>

  <label>ğŸ˜± Jumpscare Image URL:</label>
  <div class="group">
    <input type="text" id="jumpscareImage" placeholder="https://...">
    <button class="revert" id="revert-jumpimg">Revert</button>
  </div>

  <label>ğŸ•¹ï¸ Trigger Jumpscare Manually:</label>
  <div class="group">
    <button id="trigger-jumpscare">âš¡ Trigger Now</button>
  </div>
  
  <div class="group">
    <button id="reset-clickData">ğŸ—‘ï¸ Reset Most Popular Games</button>
  </div>
  
  <hr style="margin: 30px 0; border: 1px solid #333;">

  <h2>ğŸ’€ Troll Controls</h2>

  <div class="group">
    <button id="cursor-chaos">ğŸŒ€ Cursor Chaos</button>
  </div>
  
  <div class="group" style="flex-direction: column; align-items: flex-start;">
    <button id="choose-sound">ğŸµ Play Sound</button>
    <button id="stop-sound">â¹ï¸ Stop Audio</button>
    <div id="sound-menu" style="display:none; background:#222; padding:10px; border-radius:8px; margin-top:10px; max-height:200px; overflow:auto;"></div>
  </div>

  <div class="group">
    <button id="flashbang">ğŸ’¥ Flashbang Mode</button>
    <button id="reverse-controls">ğŸ”„ Reverse Controls</button>
  </div>
  
  <label>ğŸ‘¥ Live User Counter:</label>
  <div class="group">
    <span id="user-count">Loading...</span>
  </div>

  <br>
  <button id="save">ğŸ’¾ Save Changes</button>
  <button id="logout" style="background:#d9534f;">ğŸšª Logout</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyC-IDS2wfF3ZgVzjwf0cHUazNGolLFhXVQ",
  authDomain: "mostpopular-39c60.firebaseapp.com",
  databaseURL: "https://mostpopular-39c60-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "mostpopular-39c60",
  storageBucket: "mostpopular-39c60.appspot.com",
  messagingSenderId: "939775132675",
  appId: "1:939775132675:web:7d40bd8fff497c53553a36",
  measurementId: "G-XTTQ03YFN9"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

const settingsRef = db.ref("siteSettings");
const trollRef = db.ref("trollTriggers");
const usersRef = db.ref("connectedUsers");

// ---------------- LOGIN ----------------
const loginBtn = document.getElementById("login-btn");
const logoutBtn = document.getElementById("logout");
const loginBox = document.getElementById("login-box");
const adminContent = document.getElementById("admin-content");

loginBtn.onclick = async () => {
  const email = document.getElementById("admin-email").value.trim();
  const password = document.getElementById("admin-pass").value.trim();
  if (!email || !password) return alert("âŒ Enter email & password!");

  try {
    const userCredential = await auth.signInWithEmailAndPassword(email, password);
    const user = userCredential.user;

    // Check if user is admin
    const adminSnap = await db.ref('admins/' + user.uid).once('value');
    if (!adminSnap.exists()) {
      alert("âŒ You are not an admin!");
      await auth.signOut();
      return;
    }

    loginBox.style.display = "none";
    adminContent.style.display = "block";
    loadSettings();
    watchUserCount();
    alert("âœ… Login successful!");

  } catch (err) {
    console.error(err);
    alert("âŒ Login failed: " + err.message);
  }
};

logoutBtn.onclick = async () => {
  await auth.signOut();
  loginBox.style.display = "block";
  adminContent.style.display = "none";
  alert("ğŸšª Logged out");
};

// ---------------- AUTH CHECK ----------------
auth.onAuthStateChanged(user => {
  if (user) {
    // Optional: auto-show admin if logged in
    loginBox.style.display = "none";
    adminContent.style.display = "block";
    loadSettings();
    watchUserCount();
  } else {
    loginBox.style.display = "block";
    adminContent.style.display = "none";
  }
});

// ---------------- LOAD SETTINGS ----------------
const defaultSettings = { backgroundColor:"#0a0a0a", announcement:"", jumpscareImage:"" };
function loadSettings() {
  settingsRef.once("value").then(snapshot => {
    const s = snapshot.val() || defaultSettings;
    document.getElementById("bgColor").value = s.backgroundColor || defaultSettings.backgroundColor;
    document.getElementById("announcement").value = s.announcement || defaultSettings.announcement;
    document.getElementById("jumpscareImage").value = s.jumpscareImage || defaultSettings.jumpscareImage;
  });
}

// ---------------- WATCH USERS ----------------
function watchUserCount() {
  usersRef.on("value", snap => {
    document.getElementById("user-count").textContent = snap.numChildren() + " online";
  });
}

// ---------------- SAFE WRITE ----------------
async function safeWrite(path, data) {
  const user = auth.currentUser;
  if (!user) return alert("âŒ You must be logged in!");
  return db.ref(path).set(data);
}

// ---------------- BUTTON HANDLERS ----------------
document.getElementById("save").onclick = async () => {
  const settings = {
    backgroundColor: document.getElementById("bgColor").value,
    announcement: document.getElementById("announcement").value,
    jumpscareImage: document.getElementById("jumpscareImage").value
  };
  try { await safeWrite("siteSettings", settings); alert("âœ… Changes saved!"); }
  catch(e){ console.error(e); alert("âŒ Save failed!"); }
};

document.getElementById("trigger-announcement").onclick = async () => {
  const text = document.getElementById("announcement").value.trim();
  if(!text) return alert("âŒ No announcement!");
  await safeWrite("announcementTriggerNow", { text, timestamp: Date.now() });
  alert("ğŸ“¢ Announcement triggered!");
};

document.getElementById("trigger-jumpscare").onclick = async () => {
  const image = document.getElementById("jumpscareImage").value.trim();
  if(!image) return alert("âŒ Enter jumpscare image URL!");
  await safeWrite("jumpscareTriggerNow", { image, timestamp: Date.now() });
  alert("ğŸ˜± Jumpscare triggered!");
};

document.getElementById("reset-clickData").onclick = async () => {
  if(!confirm("âš ï¸ Reset all Most Popular Games data?")) return;
  await safeWrite("clickData", null);
  alert("âœ… Data reset!");
};

document.getElementById("cursor-chaos").onclick = async () => await safeWrite("trollTriggers/cursorChaos", { active:true, timestamp:Date.now() });
document.getElementById("flashbang").onclick = async () => await safeWrite("trollTriggers/flashbang", { active:true, timestamp:Date.now() });
document.getElementById("reverse-controls").onclick = async () => await safeWrite("trollTriggers/reverseControls", { active:true, timestamp:Date.now() });

// Sound buttons
const soundMenu = document.getElementById("sound-menu");
const stopSoundBtn = document.getElementById("stop-sound");
const chooseSoundBtn = document.getElementById("choose-sound");
const soundFiles = ["clashintro.mp3","rainingtacos.mp3","brainrot.mp3","wideputin.mp3","crabrave.mp3","sodapop.mp3","galaxy.mp3","67.mp3","smokedetector.mp3"];

chooseSoundBtn.onclick = () => {
  if(!auth.currentUser) return alert("âŒ Login first!");
  soundMenu.innerHTML="";
  soundFiles.forEach(file=>{
    const btn=document.createElement("button");
    btn.textContent="â–¶ï¸ "+file;
    btn.style.display="block"; btn.style.margin="5px 0";
    btn.onclick=async()=>{ await safeWrite("trollTriggers/creepySound",{url:file,timestamp:Date.now()}); alert(`ğŸ”Š ${file} triggered!`);}
    soundMenu.appendChild(btn);
  });
  soundMenu.style.display = soundMenu.style.display === "none" ? "block" : "none";
};

stopSoundBtn.onclick = async () => { await safeWrite("trollTriggers/creepySound", null); alert("â¹ï¸ Audio stopped."); };

// ---------------- REVERT BUTTONS ----------------
document.getElementById("revert-bg").onclick = () => document.getElementById("bgColor").value = defaultSettings.backgroundColor;
document.getElementById("revert-ann").onclick = () => document.getElementById("announcement").value = defaultSettings.announcement;
document.getElementById("revert-jumpimg").onclick = () => document.getElementById("jumpscareImage").value = defaultSettings.jumpscareImage;

</script>
</body>
</html>
