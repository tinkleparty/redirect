<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel</title>
  <style>
    body {
      background-color: #111;
      color: white;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }
    h1 { color: #4CAF50; }
    input, textarea {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      border-radius: 6px;
      border: none;
      outline: none;
      font-size: 14px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover { background-color: #45a049; }
    .revert {
      background-color: #d9534f;
      margin-left: 10px;
    }
    .revert:hover {
      background-color: #c9302c;
    }
    #login-box {
      text-align: center;
      margin-top: 100px;
    }
    #admin-content {
      display: none;
      max-width: 600px;
      margin: auto;
    }
    label {
      display: block;
      margin-top: 20px;
      font-weight: bold;
    }
    .group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    input[type="color"] {
      width: 60px;
      height: 35px;
      padding: 0;
      border-radius: 4px;
    }
    input[type="file"] {
      padding: 6px 0;
    }
    .sound-btn {
      display: block;
      width: 100%;
      text-align: left;
      padding: 8px;
      margin: 4px 0;
      background: #333;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .sound-btn:hover {
      background: #444;
    }
  </style>
</head>
<body>

<div id="login-box">
  <h2>ğŸ”’ Admin Login</h2>
  <input type="password" id="admin-pass" placeholder="Enter password..." />
  <button id="login-btn">Login</button>
</div>

<div id="admin-content">
  <h1>ğŸ› ï¸ Live Site Controls</h1>

  <label>ğŸ¨ Background Color:</label>
  <div class="group">
    <input type="color" id="bgColor">
    <button class="revert" id="revert-bg">Revert</button>
  </div>

  <label>ğŸ§¾ Announcement (HTML supported):</label>
  <div class="group" style="flex-direction: column; align-items: flex-start;">
    <textarea id="announcement" rows="3" placeholder="Enter announcement..."></textarea>
    <div>
      <button id="trigger-announcement">ğŸ“¢ Trigger Announcement</button>
      <button class="revert" id="revert-ann">Revert</button>
    </div>
  </div>

  <label>ğŸ˜± Jumpscare Image URL:</label>
  <div class="group">
    <input type="text" id="jumpscareImage" placeholder="https://...">
    <button class="revert" id="revert-jumpimg">Revert</button>
  </div>

  <label>ğŸ•¹ï¸ Trigger Jumpscare Manually:</label>
  <div class="group">
    <button id="trigger-jumpscare">âš¡ Trigger Now</button>
  </div>

  <hr style="margin: 30px 0; border: 1px solid #333;">

  <h2>ğŸ’€ Troll Controls</h2>

  <div class="group">
    <button id="cursor-chaos">ğŸŒ€ Cursor Chaos</button>
  </div>

  <div class="group" style="flex-direction: column; align-items: flex-start;">
    <button id="choose-sound">ğŸµ Play Sound</button>
    <button id="stop-sound">â¹ï¸ Stop Audio</button>

    <label>ğŸ”‰ Volume:</label>
    <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">

    <label>â¬†ï¸ Upload MP3 File:</label>
    <input type="file" id="upload-sound" accept=".mp3" />
    <button id="upload-btn">ğŸ“¤ Upload</button>

    <div id="sound-menu" style="display:none; background:#222; padding:10px; border-radius:8px; margin-top:10px; max-height:200px; overflow:auto;"></div>
  </div>

  <div class="group">
    <button id="flashbang">ğŸ’¥ Flashbang Mode</button>
    <button id="reverse-controls">ğŸ”„ Reverse Controls</button>
  </div>

  <label>ğŸ‘¥ Live User Counter:</label>
  <div class="group">
    <span id="user-count">Loading...</span>
  </div>

  <br>
  <button id="save">ğŸ’¾ Save Changes</button>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<script>
  // ğŸ”¥ Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyC-IDS2wfF3ZgVzjwf0cHUazNGolLFhXVQ",
    authDomain: "mostpopular-39c60.firebaseapp.com",
    databaseURL: "https://mostpopular-39c60-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "mostpopular-39c60",
    storageBucket: "mostpopular-39c60.appspot.com",
    messagingSenderId: "939775132675",
    appId: "1:939775132675:web:7d40bd8fff497c53553a36",
    measurementId: "Gâ€‘XTTQ03YFN9"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const storage = firebase.storage();
  const settingsRef = db.ref("siteSettings");
  const trollRef = db.ref("trollTriggers");
  const usersRef = db.ref("connectedUsers");
  const soundsStorageRef = storage.ref("sounds"); // folder "sounds" in storage

  // ğŸ” Login
  const PASSWORD = "admin123";
  document.getElementById("login-btn").onclick = () => {
    if (document.getElementById("admin-pass").value === PASSWORD) {
      document.getElementById("login-box").style.display = "none";
      document.getElementById("admin-content").style.display = "block";
      loadSettings();
      watchUserCount();
      loadSoundFiles();
    } else {
      alert("âŒ Wrong password!");
    }
  };

  // Default settings
  const defaultSettings = {
    backgroundColor: "#0a0a0a",
    announcement: "",
    jumpscareImage: ""
  };

  function loadSettings() {
    settingsRef.once("value").then(snapshot => {
      const s = snapshot.val() || defaultSettings;
      document.getElementById("bgColor").value = s.backgroundColor || defaultSettings.backgroundColor;
      document.getElementById("announcement").value = s.announcement || defaultSettings.announcement;
      document.getElementById("jumpscareImage").value = s.jumpscareImage || defaultSettings.jumpscareImage;
    });
  }

  document.getElementById("save").onclick = () => {
    const settings = {
      backgroundColor: document.getElementById("bgColor").value,
      announcement: document.getElementById("announcement").value,
      jumpscareImage: document.getElementById("jumpscareImage").value
    };
    settingsRef.set(settings).then(() => alert("âœ… Changes saved & live!"));
  };

  document.getElementById("trigger-announcement").onclick = () => {
    const text = document.getElementById("announcement").value.trim();
    if (!text) return alert("âŒ No announcement text!");
    db.ref("announcementTriggerNow").set({
      text: text,
      timestamp: Date.now()
    });
    alert("ğŸ“¢ Announcement triggered!");
  };

  document.getElementById("revert-bg").onclick = () => {
    document.getElementById("bgColor").value = defaultSettings.backgroundColor;
  };
  document.getElementById("revert-ann").onclick = () => {
    document.getElementById("announcement").value = defaultSettings.announcement;
  };
  document.getElementById("revert-jumpimg").onclick = () => {
    document.getElementById("jumpscareImage").value = defaultSettings.jumpscareImage;
  };

  document.getElementById("trigger-jumpscare").onclick = () => {
    const image = document.getElementById("jumpscareImage").value;
    if (!image) return alert("âŒ Please enter a jumpscare image URL first!");
    db.ref("jumpscareTriggerNow").set({ image, timestamp: Date.now() });
    alert("ğŸ˜± Jumpscare triggered!");
  };

  document.getElementById("cursor-chaos").onclick = () => {
    trollRef.child("cursorChaos").set({ active: true, timestamp: Date.now() });
  };

  document.getElementById("flashbang").onclick = () => {
    trollRef.child("flashbang").set({ active: true, timestamp: Date.now() });
  };

  document.getElementById("reverse-controls").onclick = () => {
    trollRef.child("reverseControls").set({ active: true, timestamp: Date.now() });
  };

  function watchUserCount() {
    usersRef.on("value", snap => {
      const count = snap.numChildren();
      document.getElementById("user-count").textContent = count + " online";
    });
  }

  // ğŸµ Sound controls + upload
  const soundMenu = document.getElementById("sound-menu");
  const chooseSoundBtn = document.getElementById("choose-sound");
  const stopSoundBtn = document.getElementById("stop-sound");
  const volumeSlider = document.getElementById("volume-slider");
  const uploadInput = document.getElementById("upload-sound");
  const uploadBtn = document.getElementById("upload-btn");

  let currentAudio = null;
  let currentVolume = parseFloat(volumeSlider.value);
  let soundFiles = []; // will store {name, url}

  // Volume control
  volumeSlider.oninput = () => {
    currentVolume = parseFloat(volumeSlider.value);
    if (currentAudio) {
      currentAudio.volume = currentVolume;
    }
  };

  // Load sound files from storage
  function loadSoundFiles() {
    soundsStorageRef.listAll().then(result => {
      soundFiles = [];
      result.items.forEach(itemRef => {
        itemRef.getDownloadURL().then(url => {
          soundFiles.push({ name: itemRef.name, url });
          // After gathering all or asynchronously update menu if open
        });
      });
    }).catch(err => {
      console.error("Error listing sound files:", err);
    });
  }

  chooseSoundBtn.onclick = () => {
    soundMenu.innerHTML = "";
    if (soundFiles.length === 0) {
      const noMsg = document.createElement("div");
      noMsg.textContent = "No sounds uploaded.";
      soundMenu.appendChild(noMsg);
    } else {
      soundFiles.forEach(fileObj => {
        const btn = document.createElement("button");
        btn.textContent = "â–¶ï¸ " + fileObj.name;
        btn.className = "sound-btn";
        btn.onclick = () => {
          if (currentAudio) {
            currentAudio.pause();
          }
          currentAudio = new Audio(fileObj.url);
          currentAudio.volume = currentVolume;
          currentAudio.play().catch(console.error);
          trollRef.child("creepySound").set({
            url: fileObj.url,
            timestamp: Date.now()
          });
          alert(`ğŸ”Š ${fileObj.name} triggered!`);
        };
        soundMenu.appendChild(btn);
      });
    }
    soundMenu.style.display = (soundMenu.style.display === "none" ? "block" : "none");
  };

  stopSoundBtn.onclick = () => {
    if (currentAudio) {
      currentAudio.pause();
      currentAudio.currentTime = 0;
      currentAudio = null;
      alert("â¹ï¸ Audio stopped.");
      // Clear trigger so clients know it stopped
      trollRef.child("creepySound").set(null);
    } else {
      alert("ğŸ”‡ No audio is currently playing.");
    }
  };

  // Upload sound file
  uploadBtn.onclick = () => {
    const file = uploadInput.files[0];
    if (!file) {
      return alert("âŒ Please choose an .mp3 file.");
    }
    if (!file.name.toLowerCase().endsWith(".mp3")) {
      return alert("âŒ Only .mp3 files allowed.");
    }
    const fileRef = soundsStorageRef.child(file.name);
    const uploadTask = fileRef.put(file);

    uploadTask.on('state_changed',
      snapshot => {
        // Optionally handle progress
      },
      error => {
        alert("âŒ Upload failed: " + error.message);
      },
      () => {
        fileRef.getDownloadURL().then(url => {
          alert("âœ… Upload successful!");
          // Reload list
          loadSoundFiles();
        });
      }
    );
  };

</script>
</body>
</html>
