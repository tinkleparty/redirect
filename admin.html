<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel</title>
  <style>
    body {
      background-color: #111;
      color: white;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }
    h1 { color: #4CAF50; }
    input, textarea {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      border-radius: 6px;
      border: none;
      outline: none;
      font-size: 14px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover { background-color: #45a049; }
    .revert {
      background-color: #d9534f;
      margin-left: 10px;
    }
    .revert:hover {
      background-color: #c9302c;
    }
    #login-box {
      text-align: center;
      margin-top: 100px;
    }
    #admin-content {
      display: none;
      max-width: 600px;
      margin: auto;
    }
    label {
      display: block;
      margin-top: 20px;
      font-weight: bold;
    }
    .group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    input[type="color"] {
      width: 60px;
      height: 35px;
      padding: 0;
      border-radius: 4px;
    }
  </style>
</head>
<body>

<div id="login-box">
  <h2>ğŸ”’ Admin Login</h2>
  <input type="password" id="admin-pass" placeholder="Enter password..." />
  <button id="login-btn">Login</button>
</div>

<div id="admin-content">
  <h1>ğŸ› ï¸ Live Site Controls</h1>

  <label>ğŸ¨ Background Color:</label>
  <div class="group">
    <input type="color" id="bgColor">
    <button class="revert" id="revert-bg">Revert</button>
  </div>

  <label>ğŸ§¾ Announcement (HTML supported):</label>
  <div class="group" style="flex-direction: column; align-items: flex-start;">
    <textarea id="announcement" rows="3" placeholder="Enter announcement..."></textarea>
    <div>
      <button id="trigger-announcement">ğŸ“¢ Trigger Announcement</button>
      <button class="revert" id="revert-ann">Revert</button>
    </div>
  </div>

  <label>ğŸ˜± Jumpscare Image URL:</label>
  <div class="group">
    <input type="text" id="jumpscareImage" placeholder="https://...">
    <button class="revert" id="revert-jumpimg">Revert</button>
  </div>

  <label>ğŸ•¹ï¸ Trigger Jumpscare Manually:</label>
  <div class="group">
    <button id="trigger-jumpscare">âš¡ Trigger Now</button>
  </div>
  
  <div class="group">
    <button id="reset-clickData">ğŸ—‘ï¸ Reset Most Popular Games</button>
  </div>
  
  <hr style="margin: 30px 0; border: 1px solid #333;">

  <h2>ğŸ’€ Troll Controls</h2>

  <div class="group">
    <button id="cursor-chaos">ğŸŒ€ Cursor Chaos</button>
  </div>
  
  <div class="group" style="flex-direction: column; align-items: flex-start;">
    <button id="choose-sound">ğŸµ Play Sound</button>
    <button id="stop-sound">â¹ï¸ Stop Audio</button>
    <div id="sound-menu" style="display:none; background:#222; padding:10px; border-radius:8px; margin-top:10px; max-height:200px; overflow:auto;"></div>
  </div>

  <div class="group">
    <button id="flashbang">ğŸ’¥ Flashbang Mode</button>
    <button id="reverse-controls">ğŸ”„ Reverse Controls</button>
  </div>
  
  <label>ğŸ‘¥ Live User Counter:</label>
  <div class="group">
    <span id="user-count">Loading...</span>
  </div>

  <br>
  <button id="save">ğŸ’¾ Save Changes</button>
</div>

<!-- Firebase v9 compat build -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
<script>
  // ğŸ”¥ Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyC-IDS2wfF3ZgVzjwf0cHUazNGolLFhXVQ",
    authDomain: "mostpopular-39c60.firebaseapp.com",
    databaseURL: "https://mostpopular-39c60-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "mostpopular-39c60",
    storageBucket: "mostpopular-39c60.appspot.com",
    messagingSenderId: "939775132675",
    appId: "1:939775132675:web:7d40bd8fff497c53553a36",
    measurementId: "G-XTTQ03YFN9"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const settingsRef = db.ref("siteSettings");
  const trollRef = db.ref("trollTriggers");
  const usersRef = db.ref("connectedUsers");
  const adminRef = db.ref("admin/hashedPassword");
  const tokenRefRoot = db.ref("admin/loginTokens");

  const defaultSettings = {
    backgroundColor: "#0a0a0a",
    announcement: "",
    jumpscareImage: ""
  };

  let authToken = null; // ğŸ”‘ Token for authenticated actions

  // ---------------- LOAD SETTINGS ----------------
  function loadSettings() {
    settingsRef.once("value").then(snapshot => {
      const s = snapshot.val() || defaultSettings;
      document.getElementById("bgColor").value = s.backgroundColor || defaultSettings.backgroundColor;
      document.getElementById("announcement").value = s.announcement || defaultSettings.announcement;
      document.getElementById("jumpscareImage").value = s.jumpscareImage || defaultSettings.jumpscareImage;
    });
  }

  // ---------------- WATCH USERS ----------------
  function watchUserCount() {
    usersRef.on("value", snap => {
      const count = snap.numChildren();
      document.getElementById("user-count").textContent = count + " online";
    });
  }

  // ---------------- LOGIN ----------------
  window.onload = () => {
    const loginBtn = document.getElementById("login-btn");
    const adminPassInput = document.getElementById("admin-pass");
    const loginBox = document.getElementById("login-box");
    const adminContent = document.getElementById("admin-content");

    loginBtn.onclick = async () => {
      const entered = adminPassInput.value.trim();
      if (!entered) return alert("âŒ Please enter a password!");

      try {
        const hashSnap = await adminRef.once("value");
        const hash = hashSnap.val();
        if (!hash) return alert("âš ï¸ No admin password set in database!");

        if (!dcodeIO.bcrypt.compareSync(entered, hash)) {
          return alert("âŒ Incorrect password!");
        }

        // âœ… Generate login token
        const tokenRef = await tokenRefRoot.push();
        await tokenRef.set(true);
        authToken = tokenRef.key;

        alert("âœ… Login successful!");
        loginBox.style.display = "none";
        adminContent.style.display = "block";

        loadSettings();
        watchUserCount();

      } catch (err) {
        console.error(err);
        alert("âŒ Error during login.");
      }
    };
  };

  // ---------------- SAVE SETTINGS ----------------
  document.getElementById("save").onclick = async () => {
    if (!authToken) return alert("âŒ You must be logged in!");
    const settings = {
      backgroundColor: document.getElementById("bgColor").value,
      announcement: document.getElementById("announcement").value,
      jumpscareImage: document.getElementById("jumpscareImage").value
    };
    try {
      await settingsRef.set(settings);
      alert("âœ… Changes saved & live!");
    } catch (err) {
      console.error(err);
      alert("âŒ Failed to save settings!");
    }
  };

  // ---------------- ANNOUNCEMENT ----------------
  document.getElementById("trigger-announcement").onclick = async () => {
    if (!authToken) return alert("âŒ You must be logged in!");
    const text = document.getElementById("announcement").value.trim();
    if (!text) return alert("âŒ No announcement text!");
    await db.ref("announcementTriggerNow").set({ text, timestamp: Date.now() });
    alert("ğŸ“¢ Announcement triggered!");
  };

  // ---------------- JUMPSCARE ----------------
  document.getElementById("trigger-jumpscare").onclick = async () => {
    if (!authToken) return alert("âŒ You must be logged in!");
    const image = document.getElementById("jumpscareImage").value;
    if (!image) return alert("âŒ Please enter a jumpscare image URL first!");
    await db.ref("jumpscareTriggerNow").set({ image, timestamp: Date.now() });
    alert("ğŸ˜± Jumpscare triggered!");
  };

  // ---------------- RESET CLICK DATA ----------------
  document.getElementById("reset-clickData").onclick = async () => {
    if (!authToken) return alert("âŒ You must be logged in!");
    if (!confirm("âš ï¸ Are you sure you want to reset all Most Popular Games data?")) return;
    try {
      await db.ref("clickData").remove();
      alert("âœ… Most Popular Games data has been reset!");
    } catch (err) {
      console.error(err);
      alert("âŒ Error resetting data: " + err);
    }
  };

  // ---------------- TROLL CONTROLS ----------------
  document.getElementById("cursor-chaos").onclick = async () => {
    if (!authToken) return alert("âŒ You must be logged in!");
    await trollRef.child("cursorChaos").set({ active: true, timestamp: Date.now() });
  };

  document.getElementById("flashbang").onclick = async () => {
    if (!authToken) return alert("âŒ You must be logged in!");
    await trollRef.child("flashbang").set({ active: true, timestamp: Date.now() });
  };

  document.getElementById("reverse-controls").onclick = async () => {
    if (!authToken) return alert("âŒ You must be logged in!");
    await trollRef.child("reverseControls").set({ active: true, timestamp: Date.now() });
  };

  // ---------------- SOUND CONTROL ----------------
  const soundMenu = document.getElementById("sound-menu");
  const stopSoundBtn = document.getElementById("stop-sound");
  const chooseSoundBtn = document.getElementById("choose-sound");
  const soundFiles = [
    "clashintro.mp3",
    "rainingtacos.mp3",
    "brainrot.mp3",
    "wideputin.mp3",
    "crabrave.mp3",
    "sodapop.mp3",
    "galaxy.mp3",
    "67.mp3",
    "smokedetector.mp3"
  ];

  chooseSoundBtn.onclick = () => {
    if (!authToken) return alert("âŒ You must be logged in!");
    soundMenu.innerHTML = "";
    soundFiles.forEach(file => {
      const btn = document.createElement("button");
      btn.textContent = "â–¶ï¸ " + file;
      btn.style.display = "block";
      btn.style.margin = "5px 0";
      btn.onclick = async () => {
        await trollRef.child("creepySound").set({ url: file, timestamp: Date.now() });
        alert(`ğŸ”Š ${file} triggered!`);
      };
      soundMenu.appendChild(btn);
    });
    soundMenu.style.display = soundMenu.style.display === "none" ? "block" : "none";
  };

  stopSoundBtn.onclick = async () => {
    if (!authToken) return alert("âŒ You must be logged in!");
    await trollRef.child("creepySound").set(null);
    alert("â¹ï¸ Audio stopped.");
  };

  // ---------------- REVERT BUTTONS ----------------
  document.getElementById("revert-bg").onclick = () => document.getElementById("bgColor").value = defaultSettings.backgroundColor;
  document.getElementById("revert-ann").onclick = () => document.getElementById("announcement").value = defaultSettings.announcement;
  document.getElementById("revert-jumpimg").onclick = () => document.getElementById("jumpscareImage").value = defaultSettings.jumpscareImage;

</script>
</body>
</html>
